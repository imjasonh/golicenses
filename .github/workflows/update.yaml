name: Update

on:
  workflow_dispatch:
  push:
    branches: ['main']
    paths-ignore: ['README.md']
  schedule:
  - cron: '23 1 * * 1' # Monday at 1:23 AM

permissions:
  id-token: write # Enable OIDC
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: 1.18.x
    # Install and setup gitsign so commits are signed by OIDC.
    - uses: wlynch/gitsign-action@main

    - uses: google-github-actions/auth@v0
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
    - uses: google-github-actions/setup-gcloud@v0.6.0
      with:
        project_id: jason-chainguard

    - run: |
        # The first time it's run, bq poops out a bunch of setup stuff to
        # stdout, which we don't want in our CSV, so we dry-run the query
        # to hopefully get that out of the way.
        cat query.txt | bq query --dry_run=true

        ./update.sh

        # If licenses.csv has changed, commit it.
        diff=$(git diff-index HEAD | grep licenses.csv$)
        if [[ $diff -eq 0 ]]; then
          # Delete creds before they're committed to the repo.
          rm gha-creds*.json || true

          git config user.name "Automated"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          timestamp=$(date -u)
          git commit -m "Update: ${timestamp}" || exit 0
          git push
        fi

